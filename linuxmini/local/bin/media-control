#!/usr/bin/env python3

import socket
import sys
import subprocess
import re
import os

def get_mpv_socket():
    """Find the jellyfin-mpv-shim mpv IPC socket"""
    try:
        result = subprocess.run(
            ["ps", "aux"],
            capture_output=True,
            text=True,
            timeout=0.5
        )
        for line in result.stdout.split('\n'):
            if 'jellyfin-mpv-shim' in line or ('mpv' in line and 'input-ipc-server' in line):
                match = re.search(r'--input-ipc-server=(\S+)', line)
                if match:
                    socket_path = match.group(1)
                    # Verify socket exists
                    if os.path.exists(socket_path):
                        return socket_path
    except Exception:
        pass
    return None

def send_mpv_command(socket_path, command):
    """Send command to mpv via IPC socket"""
    try:
        sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
        sock.settimeout(0.5)
        sock.connect(socket_path)
        sock.send(f'{{"command": {command}}}\n'.encode('utf-8'))
        sock.close()
        return True
    except Exception:
        return False

def fallback_to_playerctl(action):
    """Fallback to playerctl for other media players"""
    playerctl_commands = {
        "play-pause": ["playerctl", "--all-players", "play-pause"],
        "play": ["playerctl", "--all-players", "play"],
        "pause": ["playerctl", "--all-players", "pause"],
        "next": ["playerctl", "--all-players", "next"],
        "prev": ["playerctl", "--all-players", "previous"],
        "stop": ["playerctl", "--all-players", "stop"],
        "seek-forward": ["playerctl", "--all-players", "position", "5+"],
        "seek-backward": ["playerctl", "--all-players", "position", "5-"],
    }

    if action in playerctl_commands:
        try:
            subprocess.run(playerctl_commands[action], check=False)
            return True
        except Exception:
            return False
    return False

def main():
    if len(sys.argv) < 2:
        print("Usage: jellyfin-media-control [play-pause|play|pause|next|prev|stop|seek-forward|seek-backward]")
        sys.exit(1)

    action = sys.argv[1]

    # Map actions to mpv commands (JSON format)
    mpv_commands = {
        "play-pause": '["cycle", "pause"]',
        "play": '["set_property", "pause", false]',
        "pause": '["set_property", "pause", true]',
        "next": '["playlist-next"]',
        "prev": '["playlist-prev"]',
        "stop": '["stop"]',
        "seek-forward": '["seek", 5]',
        "seek-backward": '["seek", -5]',
    }

    if action not in mpv_commands:
        print(f"Unknown action: {action}", file=sys.stderr)
        print("Valid actions: " + ", ".join(mpv_commands.keys()), file=sys.stderr)
        sys.exit(1)

    # Try jellyfin-mpv-shim first
    socket_path = get_mpv_socket()
    if socket_path and send_mpv_command(socket_path, mpv_commands[action]):
        sys.exit(0)

    # Fallback to playerctl
    if fallback_to_playerctl(action):
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()
