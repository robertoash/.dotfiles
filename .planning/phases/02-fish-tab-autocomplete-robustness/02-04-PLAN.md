---
phase: 02-fish-tab-autocomplete-robustness
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - common/config/fish/functions/__frecent_unified_widget.fish
  - common/config/fish/conf.d/startup_functions/keybound_functions.fish
  - common/config/fish/conf.d/09_completions.fish
autonomous: false

must_haves:
  truths:
    - "Legacy __frecent_unified_widget.fish is removed or reduced to a no-op redirect"
    - "keybound_functions.fish legacy code cleaned up"
    - "Tab completion works for bare cd, cd with args, nvim bare, nvim with partial path, sudo nvim, git add, unknown commands"
    - "Shift+Tab works for all contexts showing frecency-only results"
    - "Trigger words ff/dd/aa/fff/fdd/faa still work in all contexts"
    - "Performance: Tab completion responds in <100ms for typical use"
    - "No regressions in path escaping for spaces and special characters"
  artifacts:
    - path: "common/config/fish/functions/__frecent_unified_widget.fish"
      provides: "Cleaned up redirect or removed"
    - path: "common/config/fish/conf.d/startup_functions/keybound_functions.fish"
      provides: "Cleaned up legacy keybinding functions"
  key_links: []
---

<objective>
Clean up legacy completion code that's been superseded by the new modular system, then perform comprehensive manual verification of all completion scenarios.

Purpose: The new system replaces functionality previously spread across __frecent_unified_widget.fish, __fd_unified_widget.fish, and keybound_functions.fish. Leftover code creates confusion and potential conflicts. This plan ensures the codebase is clean and verifies the complete UX through interactive testing.

Output: Cleaned legacy files, verified working completion system across all scenarios.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-03-SUMMARY.md

# Files to clean up
@common/config/fish/functions/__frecent_unified_widget.fish
@common/config/fish/conf.d/startup_functions/keybound_functions.fish
@common/config/fish/conf.d/09_completions.fish
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up legacy completion code</name>
  <files>
    common/config/fish/functions/__frecent_unified_widget.fish
    common/config/fish/conf.d/startup_functions/keybound_functions.fish
    common/config/fish/conf.d/09_completions.fish
  </files>
  <action>
**1. Clean up `__frecent_unified_widget.fish`:**

This function was the previous attempt at unified triggers. Its functionality is now fully handled by `__smart_tab_complete.fish` (which checks triggers first via `__completion_get_type`). The function itself is still referenced as a dependency of `__fd_unified_widget.fish` -- check if __fd_unified_widget.fish calls it. If yes, remove the call chain reference. If __frecent_unified_widget is not called by anything in the codebase, replace its contents with a minimal redirect:

```fish
# Superseded by __smart_tab_complete - trigger words now handled there
function __frecent_unified_widget
    __smart_tab_complete
end
```

This ensures any stale references don't break, while routing through the new system.

**2. Clean up `keybound_functions.fish`:**

This file contains `backward-kill-to-slash` (not implemented for fish, just an error message) and `__fzf_path_complete` (an older fzf path completer that references `$BUFFER` -- a zsh variable that doesn't exist in fish). Both functions are dead code.

Replace the entire file with:

```fish
# Legacy keybinding helper functions
# backward-kill-to-slash and __fzf_path_complete removed (superseded by __smart_tab_complete)
```

Verify no other file references `backward-kill-to-slash` or `__fzf_path_complete` before removing. Search with:
```bash
grep -r "backward-kill-to-slash\|__fzf_path_complete" ~/.dotfiles/common/config/fish/
```

**3. Clean up `09_completions.fish`:**

The comments at the bottom reference "enhanced completions removed" and "trigger sequences handled by key bindings". Update these comments to reflect the new system:

Replace the old comments (lines 23-29) with:
```fish
# Tab completion: __smart_tab_complete handles context-aware completion with fzf
# Shift+Tab: __shift_tab_complete handles frecency-only picking
# Triggers: ff/dd/aa (frecent), fff/fdd/faa (fd) handled within __smart_tab_complete
```

**Do NOT modify the functional parts of 09_completions.fish** (the completion directory loading, frecent completions, or hass-cli setup).
  </action>
  <verify>
1. `grep -r "__frecent_unified_widget" ~/.dotfiles/common/config/fish/` -- only referenced in its own file (not called from keybindings or other files)
2. `grep -r "backward-kill-to-slash\|__fzf_path_complete" ~/.dotfiles/common/config/fish/` -- only in keybound_functions.fish itself
3. Syntax check all modified files: `fish -n` on each
4. Source all conf.d files without error: `for f in common/config/fish/conf.d/*.fish; fish -n $f; end`
  </verify>
  <done>
Legacy __frecent_unified_widget.fish reduced to redirect stub. keybound_functions.fish cleaned of dead code. 09_completions.fish comments updated to reflect new system. No dangling references remain.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Comprehensive interactive verification</name>
  <files>common/config/fish/functions/__smart_tab_complete.fish</files>
  <action>
This is a human verification checkpoint. Present the test matrix below to the user and wait for their confirmation.

What was built: Complete Tab/Shift+Tab completion system with context-aware Tab completion (dirs/files/both/native based on command), frecency integration (zoxide/fre results prioritized), Shift+Tab frecency-only picker, remote path completion for scp/rsync, trigger words (ff/dd/aa/fff/fdd/faa), and legacy code cleanup.

Open a new fish shell (to pick up all changes) and test each scenario:

**Tab Completion - Basic:**
1. Empty line + Tab -> fish native completion (shows commands)
2. `cd ` + Tab -> fzf picker with zoxide dirs at top, then fd dirs
3. `nvim ` + Tab -> fzf picker with fre files at top, then fd files
4. `cp ` + Tab -> fzf picker with both files and dirs
5. `docker ` + Tab -> fish native completion (flags/subcommands)

**Tab Completion - Context:**
6. `sudo nvim ` + Tab -> same as nvim (wrapper stripped)
7. `git add ` + Tab -> fzf with files and dirs
8. `git ` + Tab -> fish native (subcommands list)
9. `nvim ~/` + Tab -> fzf searching in home directory
10. `nvim ./src/` + Tab -> fzf searching in ./src/ if it exists

**Tab Completion - Triggers:**
11. `nvim ff` + Tab -> frecent file picker (unchanged)
12. `cd dd` + Tab -> frecent dir picker (unchanged)
13. `cat aa` + Tab -> frecent all picker (unchanged)
14. `nvim fff` + Tab -> fd file picker (unchanged)

**Shift+Tab:**
15. `cd ` + Shift+Tab -> fzf with ONLY zoxide dirs (header "Frecent")
16. `nvim ` + Shift+Tab -> fzf with ONLY fre files (header "Frecent")
17. Empty line + Shift+Tab -> fzf with both zoxide dirs and fre files
18. Verify Shift+Tab responds in <20ms (no visible delay)

**Remote Completion (if SSH hosts available):**
19. `scp hostname:` + Tab -> remote directory listing
20. `scp nonexistent:` + Tab -> silent failure within 2 seconds

**Edge Cases:**
21. Path with spaces: select a path with spaces, verify it's properly escaped
22. Rapid Tab pressing: press Tab 5 times quickly, verify no crashes/duplicates
23. Cancel fzf (Esc): verify command line is unchanged
24. `cd` (no space, bare) + Tab -> should trigger smart completion

**Performance:**
25. `cd ` + Tab -> fzf appears in <100ms (no perceivable lag)
26. `nvim ` + Tab -> fzf appears in <100ms
  </action>
  <verify>User confirms all 26 test scenarios pass by typing "approved" or describes failures</verify>
  <done>All interactive test scenarios verified by user. Completion system works as designed across all command categories, trigger words, Shift+Tab frecency mode, remote paths, and edge cases.</done>
</task>

</tasks>

<verification>
1. All legacy code cleaned up without breaking references
2. All 26 test scenarios in checkpoint pass
3. Performance meets <100ms target for Tab, <20ms for Shift+Tab
4. No regressions in existing functionality
</verification>

<success_criteria>
- Legacy files cleaned up, no dead code remains
- All interactive test scenarios pass (or known exceptions documented)
- User confirms completion system works as expected
- Performance targets met
</success_criteria>

<output>
After completion, create `.planning/phases/02-fish-tab-autocomplete-robustness/02-04-SUMMARY.md`
</output>
