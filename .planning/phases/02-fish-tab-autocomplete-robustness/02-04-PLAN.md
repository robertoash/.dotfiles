---
phase: 02-fish-tab-autocomplete-robustness
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - common/config/fish/functions/__frecent_unified_widget.fish
  - common/config/fish/conf.d/startup_functions/keybound_functions.fish
  - common/config/fish/conf.d/09_completions.fish
  - common/config/fish/tests/test_completion.fish
autonomous: false

must_haves:
  truths:
    - "Legacy __frecent_unified_widget.fish is removed or reduced to a no-op redirect"
    - "keybound_functions.fish legacy code cleaned up"
    - "Tab completion works for cd, cd with args, nvim bare, nvim with partial path, sudo nvim, git add, unknown commands"
    - "Reasoning labels visible in fzf for all completion types"
    - "Smart ordering works: cd shows immediate children first, nvim shows recent files first"
    - "Trigger words ff/dd/aa/fff/fdd/faa still work in all contexts"
    - "fzf preview toggles with Ctrl+P showing correct content"
    - "Performance: Tab completion responds in <100ms for typical use"
    - "No regressions in path escaping for spaces and special characters"
    - "Automated regression test passes all assertions for __completion_get_type"
  artifacts:
    - path: "common/config/fish/functions/__frecent_unified_widget.fish"
      provides: "Cleaned up redirect or removed"
    - path: "common/config/fish/conf.d/startup_functions/keybound_functions.fish"
      provides: "Cleaned up legacy keybinding functions"
    - path: "common/config/fish/tests/test_completion.fish"
      provides: "Automated regression test for completion system"
      contains: "assert_type"
  key_links: []
---

<objective>
Clean up legacy completion code that's been superseded by the new modular system, then perform comprehensive manual verification of the new smart ordering and reasoning label UX.

Purpose: The new system replaces functionality previously spread across __frecent_unified_widget.fish, __fd_unified_widget.fish, and keybound_functions.fish. Leftover code creates confusion and potential conflicts. This plan ensures the codebase is clean and verifies the complete UX through interactive testing focusing on the new smart ordering and reasoning labels.

Output: Cleaned legacy files, automated regression test script, verified working completion system with smart ordering and reasoning labels across all scenarios.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-03-SUMMARY.md

# Files to clean up
@common/config/fish/functions/__frecent_unified_widget.fish
@common/config/fish/conf.d/startup_functions/keybound_functions.fish
@common/config/fish/conf.d/09_completions.fish
</context>

<tasks>

<task type="auto">
  <name>Task 1: Clean up legacy completion code</name>
  <files>
    common/config/fish/functions/__frecent_unified_widget.fish
    common/config/fish/conf.d/startup_functions/keybound_functions.fish
    common/config/fish/conf.d/09_completions.fish
    common/config/fish/tests/test_completion.fish
  </files>
  <action>
**1. Clean up `__frecent_unified_widget.fish`:**

This function was the previous attempt at unified triggers. Its functionality is now fully handled by `__smart_tab_complete.fish` (which checks triggers first via `__completion_get_type`). The function itself is still referenced as a dependency of `__fd_unified_widget.fish` -- check if __fd_unified_widget.fish calls it. If yes, remove the call chain reference. If __frecent_unified_widget is not called by anything in the codebase, replace its contents with a minimal redirect:

```fish
# Superseded by __smart_tab_complete - trigger words now handled there
function __frecent_unified_widget
    __smart_tab_complete
end
```

This ensures any stale references don't break, while routing through the new system.

**2. Clean up `keybound_functions.fish`:**

This file contains `backward-kill-to-slash` (not implemented for fish, just an error message) and `__fzf_path_complete` (an older fzf path completer that references `$BUFFER` -- a zsh variable that doesn't exist in fish). Both functions are dead code.

Replace the entire file with:

```fish
# Legacy keybinding helper functions
# backward-kill-to-slash and __fzf_path_complete removed (superseded by __smart_tab_complete)
```

Verify no other file references `backward-kill-to-slash` or `__fzf_path_complete` before removing. Search with:
```bash
grep -r "backward-kill-to-slash\|__fzf_path_complete" ~/.dotfiles/common/config/fish/
```

**3. Clean up `09_completions.fish`:**

The comments at the bottom reference "enhanced completions removed" and "trigger sequences handled by key bindings". Update these comments to reflect the new system:

Replace the old comments (lines 23-29) with:
```fish
# Tab completion: __smart_tab_complete handles context-aware completion with smart ordering and reasoning labels
# Trigger words: ff/dd/aa (frecent), fff/fdd/faa (fd) handled within __smart_tab_complete
# Preview: Ctrl+P toggles preview in fzf (hidden by default)
```

**Do NOT modify the functional parts of 09_completions.fish** (the completion directory loading, frecent completions, or hass-cli setup).

**4. Create automated regression test script `common/config/fish/tests/test_completion.fish`:**

A lightweight test harness that validates `__completion_get_type` deterministically (no interactive fzf). This enables regression testing after future changes.

```fish
#!/usr/bin/env fish
# Automated regression tests for the completion system
# Run: fish common/config/fish/tests/test_completion.fish

set -l pass 0
set -l fail 0

function assert_type -a expected description
    set -l actual (__completion_get_type)
    if test "$actual" = "$expected"
        set -g pass (math $pass + 1)
    else
        set -g fail (math $fail + 1)
        echo "FAIL: $description - expected '$expected', got '$actual'"
    end
end

# Source all completion functions
source (status dirname)/../functions/__completion_config.fish

# Test: directory commands
commandline -r "cd "; assert_type dirs "cd -> dirs"
commandline -r "z "; assert_type dirs "z -> dirs"
commandline -r "pushd "; assert_type dirs "pushd -> dirs"

# Test: file commands
commandline -r "nvim "; assert_type files "nvim -> files"
commandline -r "cat "; assert_type files "cat -> files"
commandline -r "bat "; assert_type files "bat -> files"

# Test: both commands
commandline -r "cp "; assert_type both "cp -> both"
commandline -r "mv "; assert_type both "mv -> both"

# Test: native commands
commandline -r "docker "; assert_type native "docker -> native"
commandline -r "git "; assert_type native "git -> native"

# Test: git subcommand detection
commandline -r "git add "; assert_type both "git add -> both"
commandline -r "git diff "; assert_type both "git diff -> both"

# Test: wrapper stripping
commandline -r "sudo nvim "; assert_type files "sudo nvim -> files"
commandline -r "sudo cd "; assert_type dirs "sudo cd -> dirs"

# Test: trigger words
commandline -r "ff"; assert_type "trigger:ff" "ff -> trigger:ff"
commandline -r "dd"; assert_type "trigger:dd" "dd -> trigger:dd"

# Test: empty command line
commandline -r ""; assert_type native "empty -> native"

# Test: unknown command defaults to both
commandline -r "someunknowncmd "; assert_type both "unknown -> both"

# Report
commandline -r ""
echo ""
echo "Results: $pass passed, $fail failed"
if test $fail -gt 0
    exit 1
end
```

This script tests 17 core scenarios deterministically. Run with `fish common/config/fish/tests/test_completion.fish` after any change to the completion system. It catches regressions in command categorization and context detection without requiring interactive fzf sessions.
  </action>
  <verify>
1. `grep -r "__frecent_unified_widget" ~/.dotfiles/common/config/fish/` -- only referenced in its own file (not called from keybindings or other files)
2. `grep -r "backward-kill-to-slash\|__fzf_path_complete" ~/.dotfiles/common/config/fish/` -- only in keybound_functions.fish itself
3. Syntax check all modified files: `fish -n` on each
4. Source all conf.d files without error: `for f in common/config/fish/conf.d/*.fish; fish -n $f; end`
5. `fish common/config/fish/tests/test_completion.fish` passes all 17 assertions
  </verify>
  <done>
Legacy __frecent_unified_widget.fish reduced to redirect stub. keybound_functions.fish cleaned of dead code. 09_completions.fish comments updated to reflect new system with smart ordering and reasoning labels. No dangling references remain. Automated regression test script created with 17 deterministic test cases for __completion_get_type.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Comprehensive interactive verification of new UX</name>
  <files>common/config/fish/functions/__smart_tab_complete.fish</files>
  <action>
This is a human verification checkpoint. Present the test matrix below to the user and wait for their confirmation.

What was built: Complete Tab completion system with context-aware smart ordering and reasoning labels. Key features: (1) cd shows immediate children [child] first, then frecency-sorted dirs [z:rank]/[fre:rank], (2) nvim shows recently edited files [fre:1], [fre:2] first, (3) each entry explains WHY it was suggested, (4) Ctrl+P toggles preview (bat for files, eza for dirs), (5) trigger words unchanged, (6) remote path completion via SSH.

Open a new fish shell (to pick up all changes) and test each scenario:

**Tab Completion - Smart Ordering & Reasoning Labels:**
1. `cd ` + Tab -> fzf shows immediate children with [child] label FIRST, then deeper dirs with [z:N] or [fre:N] labels
2. `nvim ` + Tab -> fzf shows recently edited files with [fre:1], [fre:2], [fre:3] at the TOP
3. `cp ` + Tab -> fzf shows frecency-aware files and dirs with [z:freq] or [fre:freq] labels
4. Verify reasoning labels are VISIBLE and explain ordering in all three cases above

**Tab Completion - Preview Toggle:**
5. `cd ` + Tab, then press Ctrl+P -> preview pane appears on right showing directory contents (eza or ls)
6. `nvim ` + Tab, then press Ctrl+P -> preview pane appears showing file contents (bat or cat)
7. Press Ctrl+P again -> preview hides (toggle works)
8. Verify preview is HIDDEN by default (doesn't slow down completion)

**Tab Completion - Context:**
9. `sudo nvim ` + Tab -> same as nvim (wrapper stripped), shows fre files with labels
10. `git add ` + Tab -> fzf with files and dirs
11. `git ` + Tab -> fish native completion (subcommands list)
12. `docker ` + Tab -> fish native completion (flags/subcommands)
13. `nvim ~/` + Tab -> fzf searching in home directory
14. `nvim ./src/` + Tab -> fzf searching in ./src/ if it exists

**Tab Completion - Triggers (unchanged):**
15. `nvim ff` + Tab -> frecent file picker (no change from before)
16. `cd dd` + Tab -> frecent dir picker (no change from before)
17. `cat aa` + Tab -> frecent all picker (no change from before)
18. `nvim fff` + Tab -> fd file picker (no change from before)

**Tab Completion - Unknown Commands:**
19. `unknowncmd ` + Tab -> if fish has native completion, show that; otherwise show files with labels
20. Empty line + Tab -> fish native completion (command list)

**Remote Completion (if SSH hosts available):**
21. `scp hostname:` + Tab -> remote directory listing
22. `scp nonexistent:` + Tab -> silent failure within 2 seconds

**Edge Cases:**
23. Path with spaces: select a path with spaces, verify it's properly escaped
24. Rapid Tab pressing: press Tab 5 times quickly, verify no crashes/duplicates
25. Cancel fzf (Esc): verify command line is unchanged
26. `cd` (no space, bare) + Tab -> should trigger smart completion with reasoning labels

**Performance & UX:**
27. `cd ` + Tab -> fzf appears in <100ms (no perceivable lag)
28. `nvim ` + Tab -> fzf appears in <100ms
29. Reasoning labels are concise (4-10 chars) and don't clutter the UI
30. Smart ordering makes sense: most likely items appear first based on context
  </action>
  <verify>User confirms all 30 test scenarios pass by typing "approved" or describes failures</verify>
  <done>All interactive test scenarios verified by user. Completion system works as designed with smart context-aware ordering, reasoning labels explaining suggestions, Ctrl+P preview toggle, trigger words unchanged, remote paths working, and edge cases handled. User confirms UX improvements are effective and ordering makes sense.</done>
</task>

</tasks>

<verification>
1. All legacy code cleaned up without breaking references
2. All 30 test scenarios in checkpoint pass
3. Performance meets <100ms target for Tab completion
4. Reasoning labels visible and helpful in fzf
5. Smart ordering works correctly: immediate children first for cd, recent files first for nvim
6. Ctrl+P preview toggle works and is hidden by default
7. No regressions in existing functionality
</verification>

<success_criteria>
- Legacy files cleaned up, no dead code remains
- Automated regression test (17 assertions) passes
- All interactive test scenarios pass (or known exceptions documented)
- User confirms smart ordering is effective and intuitive
- User confirms reasoning labels are helpful and not cluttered
- User confirms preview toggle works as expected
- Performance targets met
- Trigger words unchanged (ff/dd/aa/fff/fdd/faa)
- No Shift+Tab functionality present
</success_criteria>

<output>
After completion, create `.planning/phases/02-fish-tab-autocomplete-robustness/02-04-SUMMARY.md`
</output>
