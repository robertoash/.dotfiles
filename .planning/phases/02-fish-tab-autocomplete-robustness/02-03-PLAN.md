---
phase: 02-fish-tab-autocomplete-robustness
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - common/config/fish/functions/__smart_tab_complete.fish
  - common/config/fish/functions/__shift_tab_complete.fish
  - common/config/fish/conf.d/06_keybindings.fish
autonomous: true

must_haves:
  truths:
    - "Tab triggers context-aware fzf completion with frecency+history-boosted results for all categorized commands"
    - "Shift+Tab opens frecency-only picker (zoxide/fre) regardless of command context"
    - "Tab on empty command line or command-position token uses fish native completion"
    - "Tab on remote path (host:) triggers remote completion via SSH"
    - "Trigger words (ff, dd, aa, fff, fdd, faa) still work identically"
    - "Tab behavior is predictable: same command always produces same type of completion"
    - "Path-prefixed tokens (~/Doc+Tab, ./src/+Tab) search within that directory"
    - "Results are properly escaped for paths with spaces and special characters"
  artifacts:
    - path: "common/config/fish/functions/__smart_tab_complete.fish"
      provides: "Main Tab handler integrating all completion sources"
      contains: "__smart_tab_complete"
    - path: "common/config/fish/functions/__shift_tab_complete.fish"
      provides: "Shift+Tab frecency-only picker"
      contains: "__shift_tab_complete"
    - path: "common/config/fish/conf.d/06_keybindings.fish"
      provides: "Tab and Shift+Tab keybinding registration"
      contains: "__shift_tab_complete"
  key_links:
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__completion_config.fish"
      via: "function call for context detection"
      pattern: "__completion_get_type"
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__completion_sources.fish"
      via: "function call for candidate generation"
      pattern: "__completion_sources"
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__complete_remote_path.fish"
      via: "delegation for remote paths"
      pattern: "__complete_remote_path"
    - from: "common/config/fish/conf.d/06_keybindings.fish"
      to: "common/config/fish/functions/__shift_tab_complete.fish"
      via: "Shift+Tab keybinding"
      pattern: "\\\\e\\[Z.*__shift_tab_complete"
---

<objective>
Rewrite the smart Tab handler to use the new modular completion engine (from Plan 01) and remote completion (from Plan 02). Create a new Shift+Tab handler that provides frecency-only picking. Wire both into the keybinding system.

Purpose: This is the user-facing integration that connects the completion engine to keyboard input. The Tab handler becomes cleaner (delegates to modules) and gains frecency awareness. Shift+Tab becomes the dedicated "show me my frequent files/dirs" shortcut.

Output: Rewritten __smart_tab_complete.fish, new __shift_tab_complete.fish, updated 06_keybindings.fish.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-RESEARCH.md

# Depends on Plan 01 and 02 outputs
@.planning/phases/02-fish-tab-autocomplete-robustness/02-01-SUMMARY.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-02-SUMMARY.md

# Current files to modify
@common/config/fish/functions/__smart_tab_complete.fish
@common/config/fish/conf.d/06_keybindings.fish
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite __smart_tab_complete.fish using modular engine</name>
  <files>common/config/fish/functions/__smart_tab_complete.fish</files>
  <action>
Rewrite `__smart_tab_complete.fish` to delegate to the new modular functions from Plan 01 and Plan 02. The function becomes a thin dispatcher that:

1. Calls `__completion_get_type` to determine context
2. Routes to the appropriate handler based on type
3. For fzf-based completions (dirs/files/both): calls `__completion_sources`, pipes to fzf, inserts result
4. For triggers: handles ff/dd/aa/fff/fdd/faa via existing frecent/fd logic
5. For native: delegates to `commandline -f complete`
6. For remote: delegates to `__complete_remote_path`

```fish
function __smart_tab_complete
    # Step 1: Path context extraction (for path-prefixed tokens like ~/Doc)
    set -l token (commandline -t)
    set -l search_dir "."
    set -l path_prefix ""
    set -l query_part "$token"

    if string match -q -r '/' -- "$token"
        set path_prefix (string replace -r '[^/]*$' '' -- "$token")
        set query_part (string replace -r '.*/' '' -- "$token")
        if test -n "$path_prefix"
            set -l expanded_path (string replace -r '^~' $HOME -- "$path_prefix")
            if test -d "$expanded_path"
                set search_dir "$expanded_path"
            end
        end
    end

    # Step 2: Determine context type
    set -l comp_type (__completion_get_type)

    # Step 3: Route based on type
    switch $comp_type

        # --- Trigger words ---
        case 'trigger:ff'
            set -l result (frecent --files --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return

        case 'trigger:dd'
            set -l result (frecent --dirs --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return

        case 'trigger:aa'
            set -l result (frecent --all --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return

        case 'trigger:fff' 'trigger:fdd' 'trigger:faa'
            __fd_unified_widget
            return

        # --- Native fish completion ---
        case native
            commandline -f complete
            return

        # --- Remote path completion ---
        case remote
            __complete_remote_path
            return

        # --- FZF-based completions (dirs, files, both) ---
        case dirs files both
            # Generate candidates from multi-source engine
            set -l result (__completion_sources $comp_type "$search_dir" "$query_part" | \
                command fzf \
                    --height 40% \
                    --reverse \
                    --query "$query_part" \
                    --color 'fg:#ffffff,fg+:#ffffff,bg:#010111,preview-bg:#010111,border:#7dcfff')

            if test -n "$result"
                # Restore tilde prefix if user typed ~/...
                if string match -q '~*' -- "$path_prefix"
                    set result (string replace -r "^$HOME" '~' -- "$result")
                end
                # Escape spaces and special chars for shell
                set result (string replace -a ' ' '\\ ' -- "$result")
                commandline -t -- "$result"
            end
            commandline -f repaint
    end
end
```

**UX design decisions in this handler:**

1. **Consistent fzf theming:** All fzf invocations use the same color scheme matching the user's existing config (dark bg with blue borders).

2. **Path-prefix context preserved:** If user typed `~/Documents/` and Tabs, the tilde prefix is maintained in the final result. The system doesn't expand `~` to `/home/user` in the command line.

3. **Trigger words remain unchanged:** The ff/dd/aa/fff/fdd/faa triggers work exactly as before. This maintains muscle memory and backward compatibility.

4. **Thin dispatcher pattern:** This function contains NO completion logic itself -- it delegates everything. This makes it easy to test each component independently and keeps the handler small (~60 lines vs current ~218 lines).

5. **Default to "both" for unknown commands** (via __completion_get_type): This means `someunknowncommand +Tab` shows files and dirs, which is almost always what you want.

6. **Native fish completions delegated, not merged into fzf** (per design decision in Plan 01). For `native` commands (git, docker, etc.), `commandline -f complete` opens fish's pager with flags, subcommands, and descriptions. For path-oriented commands (dirs/files/both), our multi-source engine (zoxide+fre+history+fd) is superior to fish's built-in path completion.

**Important: Do NOT change the path escaping logic.** The current `string replace -a ' ' '\\ '` pattern works for the fish command line. Using `string escape` produces different escaping that can break with some paths. Preserve the existing escaping approach.
  </action>
  <verify>
Syntax check: `fish -n common/config/fish/functions/__smart_tab_complete.fish`

Functional tests (source the file and test interactively):
1. `cd +Tab` -> shows fzf with zoxide dirs + fd dirs
2. `nvim +Tab` -> shows fzf with fre files + fd files
3. `cp +Tab` -> shows fzf with both files and dirs
4. `docker +Tab` -> falls through to native fish completion (flags/subcommands)
5. `git +Tab` -> native fish completion (subcommands)
6. `git add +Tab` -> fzf with files and dirs
7. `nvim ff+Tab` -> frecent file picker (trigger word)
8. `nvim ~/Doc+Tab` -> fzf searching within ~/Documents/
9. `scp server:+Tab` -> remote path completion (if server reachable)
10. Empty line + Tab -> native fish completion
  </verify>
  <done>
__smart_tab_complete.fish is rewritten as a thin dispatcher (~60 lines) that delegates to __completion_get_type for context detection, __completion_sources for candidate generation, __complete_remote_path for remote paths, and frecent/__fd_unified_widget for trigger words. Frecency results (zoxide/fre) now appear in standard Tab completion for the first time. All trigger words still work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Shift+Tab handler and update keybindings</name>
  <files>
    common/config/fish/functions/__shift_tab_complete.fish
    common/config/fish/conf.d/06_keybindings.fish
  </files>
  <action>
**Part A: Create `__shift_tab_complete.fish`**

Shift+Tab provides a **frecency-only picker** -- a fast way to access recently/frequently used paths without filesystem noise. This is the "I know I've been here before" shortcut.

```fish
function __shift_tab_complete
    # Shift+Tab: Frecency-only picker
    # Shows zoxide dirs + fre files, NO filesystem scanning
    # This is fast because it reads pre-computed databases, not the filesystem

    set -l token (commandline -t)
    set -l cmd (commandline -b)

    # If in fish pager (completion menu already showing), reverse-navigate
    # Fish handles this natively when the pager is active
    # Our custom handler only fires when NO pager is active

    # Determine if we should show dirs, files, or both based on command context
    set -l comp_type (__completion_get_type)

    set -l items

    switch $comp_type
        case dirs
            # cd/z/pushd: show only zoxide dirs
            if command -q zoxide
                set items (zoxide query -l 2>/dev/null | head -n 50)
            end

        case files
            # nvim/cat/bat: show only fre files
            if command -q fre
                set items (fre --sorted 2>/dev/null | head -n 50)
            end

        case native trigger:*
            # For native/trigger contexts: show everything (dirs + files)
            if command -q zoxide
                set -a items (zoxide query -l 2>/dev/null | head -n 25)
            end
            if command -q fre
                set -a items (fre --sorted 2>/dev/null | head -n 25)
            end

        case '*'
            # Default: show both
            if command -q zoxide
                set -a items (zoxide query -l 2>/dev/null | head -n 25)
            end
            if command -q fre
                set -a items (fre --sorted 2>/dev/null | head -n 25)
            end
    end

    if test (count $items) -eq 0
        commandline -f repaint
        return
    end

    # Deduplicate
    set -l unique_items (printf '%s\n' $items | awk '!seen[$0]++')

    # Present via fzf with "frecent" header to indicate this is the frecency picker
    set -l result (printf '%s\n' $unique_items | \
        command fzf \
            --height 40% \
            --reverse \
            --query "$token" \
            --header '  Frecent (Shift+Tab)' \
            --color 'fg:#ffffff,fg+:#ffffff,bg:#010111,preview-bg:#010111,border:#7dcfff')

    if test -n "$result"
        # Escape spaces for shell
        set result (string replace -a ' ' '\\ ' -- "$result")
        commandline -t -- "$result"
    end
    commandline -f repaint
end
```

**UX design decisions for Shift+Tab:**

1. **Frecency-only = fast + intentional:** Shift+Tab never scans the filesystem. It only queries pre-computed databases (zoxide, fre). This makes it nearly instant (<20ms) and shows only paths you've actually used before.

2. **Context-aware even in frecency mode:** `cd +Shift+Tab` shows only frecent dirs, `nvim +Shift+Tab` shows only frecent files. This respects command intent even in the frecency picker.

3. **"Frecent" header in fzf:** The header tells the user they're in the frecency picker, not the full completion. This provides transparency about what the system is doing. The subtle header avoids being intrusive.

4. **Empty line + Shift+Tab shows everything:** When there's no command context, show both dirs and files from frecency. This is useful for "I want to go somewhere I've been" without needing a command first.

5. **Mental model: Tab = smart search (everywhere), Shift+Tab = memory (places I've been).** This is the key UX distinction. Tab casts a wide net (frecency + filesystem), Shift+Tab is laser-focused on history.

**Part B: Update `06_keybindings.fish`**

Add Shift+Tab binding. Find the section where Tab is bound and add Shift+Tab below it:

After the existing block:
```fish
# Smart context-aware Tab completion with fzf
# Also handles triggers: ff, dd, aa, fff, fdd, faa
for mode in insert default visual
    bind -M $mode \t __smart_tab_complete
end
```

Add:
```fish
# Shift+Tab: Frecency-only picker (zoxide dirs + fre files)
# Fast access to recently/frequently used paths without filesystem scanning
for mode in insert default visual
    bind -M $mode \e[Z __shift_tab_complete
end
```

Note: `\e[Z` is the standard escape sequence for Shift+Tab across terminals (wezterm, foot, kitty, alacritty, iTerm2, Terminal.app).

**Do NOT remove or modify any existing keybindings.** Only add the Shift+Tab binding.
  </action>
  <verify>
Syntax check: `fish -n common/config/fish/functions/__shift_tab_complete.fish`

Verify keybinding file:
- `grep '__shift_tab_complete' common/config/fish/conf.d/06_keybindings.fish` returns the binding
- `grep '\\\\e\[Z' common/config/fish/conf.d/06_keybindings.fish` returns the Shift+Tab escape sequence

Functional tests:
1. `cd +Shift+Tab` -> shows fzf with only zoxide directories (header says "Frecent")
2. `nvim +Shift+Tab` -> shows fzf with only fre files
3. Empty line + Shift+Tab -> shows fzf with both zoxide dirs and fre files
4. `Shift+Tab` completes in <20ms (no filesystem scanning)
5. Tab still works as before (verify no regression)
  </verify>
  <done>
__shift_tab_complete.fish created with context-aware frecency-only picker. 06_keybindings.fish updated with Shift+Tab binding (\e[Z) for all modes (insert, default, visual). Shift+Tab shows only frecent results (no filesystem), respects command context (dirs for cd, files for nvim), and displays "Frecent" header for transparency. Tab completion unchanged.
  </done>
</task>

</tasks>

<verification>
1. Both new/modified files pass syntax check
2. Tab completion works for all scenarios: empty line, commands in all categories, trigger words, remote paths, path prefixes
3. Shift+Tab shows frecency-only results with proper context
4. No regressions: existing Tab behavior (triggers, native completion, path escaping) unchanged
5. Keybindings correctly registered for insert, default, and visual modes
6. fzf color scheme consistent across all completion modes
</verification>

<success_criteria>
- __smart_tab_complete.fish rewritten as thin dispatcher (~60 lines, down from ~218)
- All completion types work: dirs, files, both, native, remote, triggers
- Frecency results integrated into standard Tab completion
- __shift_tab_complete.fish provides frecency-only picker
- Shift+Tab bound to \e[Z across all vi modes
- Path escaping works for spaces and special characters
- Tilde prefix preserved in results
</success_criteria>

<output>
After completion, create `.planning/phases/02-fish-tab-autocomplete-robustness/02-03-SUMMARY.md`
</output>
