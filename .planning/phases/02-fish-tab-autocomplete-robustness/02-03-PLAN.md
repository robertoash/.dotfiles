---
phase: 02-fish-tab-autocomplete-robustness
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - common/config/fish/functions/__smart_tab_complete.fish
  - common/config/fish/conf.d/06_keybindings.fish
autonomous: true

must_haves:
  truths:
    - "Tab triggers context-aware fzf completion with smart ordering and reasoning labels"
    - "cd +Tab shows immediate children [child] first, then deeper directories sorted by frecency [zoxide:rank]/[fre:rank]/[history]"
    - "nvim +Tab shows recently edited files first with frecency labels"
    - "Unknown commands show fish native completion first, then files (not dirs)"
    - "Tab on empty command line uses fish native completion"
    - "Tab on remote path (host:) triggers remote completion via SSH"
    - "Trigger words (ff, dd, aa, fff, fdd, faa) still work identically"
    - "Path-prefixed tokens (~/Doc+Tab, ./src/+Tab) search within that directory"
    - "Results are properly escaped for paths with spaces and special characters"
    - "fzf preview toggles with Ctrl+P showing file contents or directory listings"
    - "Each fzf entry has a reason label explaining why it was suggested"
  artifacts:
    - path: "common/config/fish/functions/__smart_tab_complete.fish"
      provides: "Main Tab handler with smart ordering and reasoning labels"
      contains: "__smart_tab_complete"
    - path: "common/config/fish/functions/__completion_order.fish"
      provides: "Smart ordering logic with context-aware prioritization"
      contains: "__completion_order"
    - path: "common/config/fish/conf.d/06_keybindings.fish"
      provides: "Tab keybinding registration"
      contains: "__smart_tab_complete"
  key_links:
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__completion_config.fish"
      via: "function call for context detection"
      pattern: "__completion_get_type"
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__completion_sources.fish"
      via: "function call for candidate generation"
      pattern: "__completion_sources"
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__complete_remote_path.fish"
      via: "delegation for remote paths"
      pattern: "__complete_remote_path"
    - from: "common/config/fish/functions/__smart_tab_complete.fish"
      to: "common/config/fish/functions/__completion_order.fish"
      via: "ordering and labeling results"
      pattern: "__completion_order"
---

<objective>
Rewrite the smart Tab handler to use the new modular completion engine (from Plan 01) and remote completion (from Plan 02), with context-aware ordering and reasoning labels. Each completion result shows WHY it was suggested, and ordering optimizes for user intent at that moment.

Purpose: This is the user-facing integration that connects the completion engine to keyboard input. The Tab handler becomes cleaner (delegates to modules) and gains intelligent ordering based on context. Users see why each suggestion appears, helping them understand and trust the system.

Output: Rewritten __smart_tab_complete.fish, new __completion_order.fish for smart ranking, updated 06_keybindings.fish.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-RESEARCH.md

# Depends on Plan 01 and 02 outputs
@.planning/phases/02-fish-tab-autocomplete-robustness/02-01-SUMMARY.md
@.planning/phases/02-fish-tab-autocomplete-robustness/02-02-SUMMARY.md

# Current files to modify
@common/config/fish/functions/__smart_tab_complete.fish
@common/config/fish/conf.d/06_keybindings.fish
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create smart ordering module with reasoning labels</name>
  <files>common/config/fish/functions/__completion_order.fish</files>
  <action>
Create `__completion_order.fish` that implements context-aware ordering with reasoning labels. This module receives raw candidates from multiple sources and orders them intelligently based on command context.

**Key principle:** "What does user most likely want AT THIS MOMENT?"

```fish
function __completion_order
    # Arguments: context_type search_dir query_part
    # Returns: Ordered candidates with reasoning labels
    set -l context_type $argv[1]
    set -l search_dir $argv[2]
    set -l query_part $argv[3]

    set -l results

    switch $context_type
        case dirs
            # For cd/z/pushd: Immediate children first, then frecency-sorted

            # Step 1: Immediate children (depth 1) - these are most likely
            if test -d "$search_dir"
                for dir in (fd -Hi --no-ignore-vcs -t d --max-depth 1 . "$search_dir" 2>/dev/null)
                    echo "$dir	[child]"
                end
            end

            # Step 2: Zoxide directories (sorted by frecency rank)
            if command -q zoxide
                set -l zoxide_results (zoxide query -l 2>/dev/null | head -n 30)
                set -l rank 1
                for dir in $zoxide_results
                    echo "$dir	[z:$rank]"
                    set rank (math $rank + 1)
                end
            end

            # Step 3: Fre directories (if available)
            if command -q fre
                set -l fre_results (fre --sorted 2>/dev/null | string match -r '.*/$' | head -n 20)
                set -l rank 1
                for dir in $fre_results
                    echo "$dir	[fre:$rank]"
                    set rank (math $rank + 1)
                end
            end

            # Step 4: Deeper directories from filesystem
            if test -d "$search_dir"
                for dir in (fd -Hi --no-ignore-vcs -t d --min-depth 2 --max-depth 3 . "$search_dir" 2>/dev/null)
                    echo "$dir	[fs]"
                end
            end

        case files
            # For nvim/cat/bat: Recently edited files first

            # Step 1: Fre files (recently/frequently edited)
            if command -q fre
                set -l fre_results (fre --sorted 2>/dev/null | string match -v -r '.*/$' | head -n 20)
                set -l rank 1
                for file in $fre_results
                    echo "$file	[fre:$rank]"
                    set rank (math $rank + 1)
                end
            end

            # Step 2: Files in current directory (immediate context)
            if test -d "$search_dir"
                for file in (fd -Hi --no-ignore-vcs -t f --max-depth 1 . "$search_dir" 2>/dev/null)
                    echo "$file	[local]"
                end
            end

            # Step 3: Files in subdirectories
            if test -d "$search_dir"
                for file in (fd -Hi --no-ignore-vcs -t f --min-depth 2 --max-depth 3 . "$search_dir" 2>/dev/null)
                    echo "$file	[fs]"
                end
            end

        case both
            # For cp/mv/rsync: Mix of files and dirs, frecency-aware

            # Step 1: Frecency items (both files and dirs)
            if command -q zoxide
                set -l zoxide_results (zoxide query -l 2>/dev/null | head -n 15)
                for item in $zoxide_results
                    echo "$item	[z:freq]"
                end
            end

            if command -q fre
                set -l fre_results (fre --sorted 2>/dev/null | head -n 15)
                for item in $fre_results
                    echo "$item	[fre:freq]"
                end
            end

            # Step 2: Local files and directories
            if test -d "$search_dir"
                for item in (fd -Hi --no-ignore-vcs --max-depth 1 . "$search_dir" 2>/dev/null)
                    echo "$item	[local]"
                end
            end

            # Step 3: Deeper items
            if test -d "$search_dir"
                for item in (fd -Hi --no-ignore-vcs --min-depth 2 --max-depth 3 . "$search_dir" 2>/dev/null)
                    echo "$item	[fs]"
                end
            end
    end | awk '!seen[$1]++'  # Deduplicate by path, keeping first (highest priority)
end
```

**Reasoning label meanings:**
- `[child]` - Immediate subdirectory of current location
- `[z:N]` - Zoxide frecency rank (lower N = more frequent)
- `[fre:N]` - Fre frecency rank (lower N = more recent/frequent)
- `[local]` - Item in current directory
- `[fs]` - Item from filesystem scan
- `[history]` - Item from shell history (future enhancement)

**Performance:** Each source is limited (head -n 20/30) to keep <100ms. Deduplication preserves order so highest priority wins.
  </action>
  <verify>
Syntax check: `fish -n common/config/fish/functions/__completion_order.fish`

Test ordering logic:
```fish
source common/config/fish/functions/__completion_order.fish
cd ~
__completion_order dirs . "" | head -n 5  # Should show [child] items first
__completion_order files . "" | head -n 5  # Should show [fre:*] items first
```
  </verify>
  <done>
__completion_order.fish created with context-aware ordering for dirs/files/both. Implements smart prioritization: immediate children first for directories, recently edited files first for file commands, frecency-aware for both. Each entry tagged with concise reasoning label ([child], [z:5], [fre:2], [local], [fs]).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite __smart_tab_complete.fish with new ordering and preview</name>
  <files>common/config/fish/functions/__smart_tab_complete.fish</files>
  <action>
Rewrite `__smart_tab_complete.fish` to delegate to the new modular functions with smart ordering and optional fzf preview.

**Key changes from current implementation:**
1. Use `__completion_get_type` for context detection (from 02-01)
2. Use `__completion_order` for smart ordering with labels
3. Add Ctrl+P preview toggle (bat for files, eza/ls for dirs)
4. For unknown commands: Try fish native completion, then show files only (not dirs)
5. Keep all trigger words (ff/dd/aa/fff/fdd/faa) exactly as is
6. Integrate remote completion from 02-02

```fish
function __smart_tab_complete
    set -l cmd (commandline -b)
    set -l token (commandline -t)
    set -l cursor_pos (commandline -C)

    # Extract path prefix and search base for relative/absolute paths
    set -l search_dir "."
    set -l path_prefix ""
    set -l query_part "$token"

    if string match -q -r '/' -- "$token"
        # Token contains a path - extract directory portion
        set path_prefix (string replace -r '[^/]*$' '' -- "$token")
        set query_part (string replace -r '.*/' '' -- "$token")
        if test -n "$path_prefix"
            # Expand tilde for directory test and search
            set -l expanded_path (string replace -r '^~' $HOME -- "$path_prefix")
            if test -d "$expanded_path"
                set search_dir "$expanded_path"
            end
        end
    end

    # === TRIGGER WORDS (existing functionality - unchanged) ===
    # fd triggers: fff, fdd, faa
    if string match -q -r '^f(ff|dd|aa)$' -- "$token"
        __fd_unified_widget
        return
    end

    # frecent triggers: ff, dd, aa
    switch "$token"
        case ff
            set -l result (frecent --files --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return
        case dd
            set -l result (frecent --dirs --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return
        case aa
            set -l result (frecent --all --interactive 2>/dev/null)
            if test -n "$result"
                commandline -t -- (string escape "$result")
            end
            commandline -f repaint
            return
    end

    # === CONTEXT DETECTION ===
    set -l comp_type (__completion_get_type)

    # === ROUTE BASED ON TYPE ===
    switch $comp_type

        case 'trigger:ff' 'trigger:dd' 'trigger:aa' 'trigger:fff' 'trigger:fdd' 'trigger:faa'
            # Already handled above, but catch in case context detection returns this
            commandline -f repaint
            return

        case native
            # Fish native completion for commands with no path context
            # This includes: empty line, git (without subcommand), docker, etc.
            commandline -f complete
            return

        case remote
            # Remote path completion via SSH
            __complete_remote_path
            return

        case dirs files both
            # === FZF-based completions with smart ordering ===

            # Generate ordered candidates with reasoning labels
            set -l candidates (__completion_order $comp_type "$search_dir" "$query_part")

            if test -z "$candidates"
                # No candidates - fall back to fish native
                commandline -f complete
                return
            end

            # fzf with preview toggle
            # Preview: Ctrl+P to toggle
            # For files: bat (if available) or cat
            # For dirs: eza (if available) or ls
            set -l preview_cmd
            switch $comp_type
                case files
                    if command -q bat
                        set preview_cmd 'bat --color=always --style=numbers {1}'
                    else
                        set preview_cmd 'cat {1}'
                    end
                case dirs
                    if command -q eza
                        set preview_cmd 'eza -la --color=always {1}'
                    else
                        set preview_cmd 'ls -lah {1}'
                    end
                case both
                    # Handle both files and dirs
                    if command -q bat; and command -q eza
                        set preview_cmd 'test -d {1} && eza -la --color=always {1} || bat --color=always --style=numbers {1}'
                    else
                        set preview_cmd 'test -d {1} && ls -lah {1} || cat {1}'
                    end
            end

            # fzf invocation with preview toggle
            # --delimiter=\t to split path from label
            # --with-nth=1 to show only path in main view
            # --nth=1 to search only in path (not label)
            # Ctrl+P to toggle preview
            set -l result (printf '%s\n' $candidates | \
                command fzf \
                    --height 40% \
                    --reverse \
                    --query "$query_part" \
                    --delimiter '\t' \
                    --with-nth 1,2 \
                    --nth 1 \
                    --preview "$preview_cmd" \
                    --preview-window 'right:50%:hidden' \
                    --bind 'ctrl-p:toggle-preview' \
                    --color 'fg:#ffffff,fg+:#ffffff,bg:#010111,preview-bg:#010111,border:#7dcfff')

            if test -n "$result"
                # Extract just the path (before tab)
                set result (string split \t $result)[1]

                # Restore tilde prefix if user typed ~/...
                if string match -q '~*' -- "$path_prefix"
                    set result (string replace -r "^$HOME" '~' -- "$result")
                end

                # Escape spaces and special chars for shell
                set result (string replace -a ' ' '\\ ' -- "$result")
                commandline -t -- "$result"
            end
            commandline -f repaint

        case '*'
            # Unknown command: Try fish native first, then show files
            # Check if fish has completions for this command
            set -l tokens (commandline -xpc)
            set -l base_cmd $tokens[1]

            # Try native completion first
            set -l has_native_completion (complete -C "$cmd" | head -n 1)

            if test -n "$has_native_completion"
                # Fish knows about this command - use native
                commandline -f complete
                return
            else
                # Unknown command - show files only (not dirs)
                set -l candidates (__completion_order files "$search_dir" "$query_part")

                if test -z "$candidates"
                    commandline -f complete
                    return
                end

                set -l preview_cmd
                if command -q bat
                    set preview_cmd 'bat --color=always --style=numbers {1}'
                else
                    set preview_cmd 'cat {1}'
                end

                set -l result (printf '%s\n' $candidates | \
                    command fzf \
                        --height 40% \
                        --reverse \
                        --query "$query_part" \
                        --delimiter '\t' \
                        --with-nth 1,2 \
                        --nth 1 \
                        --preview "$preview_cmd" \
                        --preview-window 'right:50%:hidden' \
                        --bind 'ctrl-p:toggle-preview' \
                        --color 'fg:#ffffff,fg+:#ffffff,bg:#010111,preview-bg:#010111,border:#7dcfff')

                if test -n "$result"
                    set result (string split \t $result)[1]
                    if string match -q '~*' -- "$path_prefix"
                        set result (string replace -r "^$HOME" '~' -- "$result")
                    end
                    set result (string replace -a ' ' '\\ ' -- "$result")
                    commandline -t -- "$result"
                end
                commandline -f repaint
            end
    end
end
```

**UX design decisions:**

1. **Reasoning labels visible in fzf:** Using `--with-nth 1,2` shows both path and label. User sees WHY each item is suggested. Labels are concise (4-10 chars) to avoid clutter.

2. **Preview hidden by default:** Ctrl+P toggles preview to avoid performance impact. Shows file contents (bat) or directory listings (eza) based on context.

3. **Unknown commands get files:** For `someweirdcmd +Tab`, try fish native first, then show files. This is more useful than showing both files+dirs for unknown commands.

4. **Trigger words completely unchanged:** ff/dd/aa/fff/fdd/faa work exactly as before. No regression.

5. **Path escaping preserved:** Using existing `string replace -a ' ' '\\ '` pattern. Tested and works.

6. **fzf search only in path:** `--nth 1` means user's query only matches the path, not the label. So typing "doc" finds "Documents/" even if label is "[child]".
  </action>
  <verify>
Syntax check: `fish -n common/config/fish/functions/__smart_tab_complete.fish`

Functional tests (source the file and test interactively):
1. `cd +Tab` -> shows fzf with immediate children labeled [child] first, then zoxide dirs
2. `nvim +Tab` -> shows fzf with fre files labeled [fre:1], [fre:2], etc. at top
3. `cp +Tab` -> shows fzf with both files and dirs, frecency-aware
4. `docker +Tab` -> falls through to native fish completion (flags/subcommands)
5. `git +Tab` -> native fish completion (subcommands)
6. `git add +Tab` -> fzf with files and dirs
7. `nvim ff+Tab` -> frecent file picker (trigger word - unchanged)
8. `nvim ~/Doc+Tab` -> fzf searching within ~/Documents/
9. `cd +Tab` then press Ctrl+P -> preview appears showing directory contents
10. `nvim +Tab` then press Ctrl+P -> preview appears showing file contents
11. `unknowncmd +Tab` -> tries fish native, then shows files if no native completion
12. Empty line + Tab -> native fish completion
13. `scp server:+Tab` -> remote path completion (if server reachable)
14. Reasoning labels visible in fzf: each entry shows path + tab + label
  </verify>
  <done>
__smart_tab_complete.fish rewritten as thin dispatcher that delegates to __completion_get_type for context, __completion_order for smart ordering, and __complete_remote_path for remote paths. All completion types show reasoning labels explaining why items appear. fzf preview toggles with Ctrl+P (hidden by default). Unknown commands try fish native first, then show files only. Trigger words (ff/dd/aa/fff/fdd/faa) unchanged. Path escaping preserved.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update keybindings - remove Shift+Tab</name>
  <files>common/config/fish/conf.d/06_keybindings.fish</files>
  <action>
Update `06_keybindings.fish` to ensure Tab is bound to `__smart_tab_complete` and remove any Shift+Tab bindings.

**Find the section where Tab completion is bound** (likely near the end of the file). It should look like:

```fish
# Smart context-aware Tab completion with fzf
# Also handles triggers: ff, dd, aa, fff, fdd, faa
for mode in insert default visual
    bind -M $mode \t __smart_tab_complete
end
```

**If Shift+Tab binding exists**, remove it. Search for:
- `\e[Z` (standard Shift+Tab escape sequence)
- `__shift_tab_complete` (if previously added)
- Any other Shift+Tab references

**After cleanup, the keybinding section should have:**
```fish
# Smart context-aware Tab completion with fzf
# Handles context detection, smart ordering with reasoning labels, and trigger words
for mode in insert default visual
    bind -M $mode \t __smart_tab_complete
end
```

**Do NOT modify any other keybindings** (Ctrl+F, Ctrl+D, Ctrl+R, etc.). Only update Tab-related bindings.

**Verify no Shift+Tab references remain:**
```bash
grep -i 'shift.*tab\|\\e\[Z' common/config/fish/conf.d/06_keybindings.fish
```
Should return nothing.
  </action>
  <verify>
1. Syntax check: `fish -n common/config/fish/conf.d/06_keybindings.fish`
2. Grep verification: `grep '__smart_tab_complete' common/config/fish/conf.d/06_keybindings.fish` returns Tab binding
3. Grep verification: `grep -i 'shift.*tab\|\\e\[Z' common/config/fish/conf.d/06_keybindings.fish` returns nothing
4. Source the config and test: `bind \t` shows `__smart_tab_complete`
  </verify>
  <done>
06_keybindings.fish updated with Tab bound to __smart_tab_complete. All Shift+Tab bindings removed. Keybinding comments updated to reflect new UX (context-aware ordering, reasoning labels). No other keybindings modified.
  </done>
</task>

</tasks>

<verification>
1. All new/modified files pass syntax check
2. Tab completion works for all scenarios: empty line, dirs/files/both commands, trigger words, remote paths, path prefixes
3. Reasoning labels appear in fzf for all completion types
4. Ctrl+P toggles preview correctly (hidden by default)
5. Smart ordering: immediate children first for cd, recent files first for nvim
6. Unknown commands try fish native, then show files
7. No regressions: existing Tab behavior (triggers, native completion, path escaping) unchanged
8. No Shift+Tab functionality present
9. fzf color scheme consistent across all completion modes
</verification>

<success_criteria>
- __completion_order.fish created with context-aware ordering and reasoning labels
- __smart_tab_complete.fish rewritten as thin dispatcher with smart ordering integration
- Reasoning labels visible in fzf ([child], [z:5], [fre:2], [local], [fs])
- fzf preview toggles with Ctrl+P (bat for files, eza for dirs)
- Smart ordering: cd shows immediate children first, nvim shows recent files first
- Unknown commands try fish native first, then files only
- All trigger words work unchanged
- Path escaping works for spaces and special characters
- Tilde prefix preserved in results
- No Shift+Tab functionality present
- Tab bound correctly in all vi modes
</success_criteria>

<output>
After completion, create `.planning/phases/02-fish-tab-autocomplete-robustness/02-03-SUMMARY.md`
</output>
