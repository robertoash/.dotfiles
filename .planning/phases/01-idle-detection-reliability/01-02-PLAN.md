---
phase: 01-idle-detection-reliability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - linuxmini/systemd/user/mqtt_listener.service
  - linuxmini/systemd/user/mqtt_reports.service
  - linuxmini/systemd/user/in-office-monitor.service
  - linuxmini/systemd/user/mqtt_linux-webcam-status.service
  - linuxmini/systemd/user/hypridle.service
autonomous: false

must_haves:
  truths:
    - "MQTT services recover automatically after transient failures without hitting systemd restart limits"
    - "Services that depend on the network wait for network-online.target before starting"
    - "All idle detection services have consistent, appropriate restart policies"
  artifacts:
    - path: "linuxmini/systemd/user/mqtt_listener.service"
      provides: "Hardened systemd unit with restart limits and network dependency"
      contains: "StartLimitIntervalSec"
    - path: "linuxmini/systemd/user/mqtt_reports.service"
      provides: "Hardened systemd unit with restart limits and network dependency"
      contains: "StartLimitIntervalSec"
    - path: "linuxmini/systemd/user/in-office-monitor.service"
      provides: "Hardened systemd unit with restart limits"
      contains: "StartLimitIntervalSec"
    - path: "linuxmini/systemd/user/mqtt_linux-webcam-status.service"
      provides: "Hardened systemd unit with restart limits"
      contains: "StartLimitIntervalSec"
    - path: "linuxmini/systemd/user/hypridle.service"
      provides: "Hardened systemd unit with restart limits"
      contains: "StartLimitIntervalSec"
  key_links:
    - from: "linuxmini/systemd/user/mqtt_listener.service"
      to: "network-online.target"
      via: "After= and Wants="
      pattern: "Wants=network-online.target"
    - from: "linuxmini/systemd/user/mqtt_reports.service"
      to: "network-online.target"
      via: "After= and Wants="
      pattern: "Wants=network-online.target"
---

<objective>
Harden all idle detection systemd service units with proper restart policies, network dependencies, and start limits.

Purpose: Current services use bare `Restart=on-failure` with `RestartSec=5` and no start limits, meaning systemd's defaults (5 restarts in 10 seconds) can cause services to permanently stop after a burst of failures. MQTT services also lack `network-online.target` dependency, meaning they can start before the network is ready and fail immediately.

Output: Five updated systemd service files with consistent restart policies that allow services to survive transient failures without human intervention.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-idle-detection-reliability/01-RESEARCH.md
@linuxmini/systemd/user/mqtt_listener.service
@linuxmini/systemd/user/mqtt_reports.service
@linuxmini/systemd/user/in-office-monitor.service
@linuxmini/systemd/user/mqtt_linux-webcam-status.service
@linuxmini/systemd/user/hypridle.service
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden MQTT service units with restart policies and network dependencies</name>
  <files>
linuxmini/systemd/user/mqtt_listener.service
linuxmini/systemd/user/mqtt_reports.service
  </files>
  <action>
Update both MQTT service files with identical improvements:

**For mqtt_listener.service and mqtt_reports.service:**

1. Add `Wants=network-online.target` and `After=network-online.target` to `[Unit]` section. Keep existing `After=network.target` (append network-online.target to the After line).

2. Add restart limit configuration to `[Service]` section:
   ```ini
   StartLimitIntervalSec=300
   StartLimitBurst=10
   ```
   This allows 10 restarts in 5 minutes before systemd gives up. Much more tolerant than the default (5 in 10s).

3. Keep `Restart=on-failure` and `RestartSec=5` as-is. The paho-mqtt reconnection handles broker-level reconnection internally; systemd restarts only kick in for actual process crashes.

Final mqtt_listener.service should look like:
```ini
[Unit]
Description=MQTT Listener Service
After=network.target network-online.target
Wants=network-online.target

[Service]
Type=simple
RuntimeDirectory=mqtt
RuntimeDirectoryMode=755
Environment=PYTHONPATH=/home/rash/.config/scripts
ExecStartPre=/usr/bin/bash -c "source /home/rash/.config/scripts/mqtt/.env && echo 'Environment variables loaded'"
ExecStart=/home/rash/.config/scripts/mqtt/launch_mqtt_services.sh mqtt_listener
Restart=on-failure
RestartSec=5
StartLimitIntervalSec=300
StartLimitBurst=10
WorkingDirectory=/home/rash/.config/scripts/mqtt
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=default.target
```

mqtt_reports.service follows the same pattern (only difference is ExecStart uses `mqtt_reports` instead of `mqtt_listener`).
  </action>
  <verify>
For each file, verify the key directives are present:
```bash
grep 'network-online.target' linuxmini/systemd/user/mqtt_listener.service
grep 'StartLimitIntervalSec=300' linuxmini/systemd/user/mqtt_listener.service
grep 'StartLimitBurst=10' linuxmini/systemd/user/mqtt_listener.service
grep 'network-online.target' linuxmini/systemd/user/mqtt_reports.service
grep 'StartLimitIntervalSec=300' linuxmini/systemd/user/mqtt_reports.service
grep 'StartLimitBurst=10' linuxmini/systemd/user/mqtt_reports.service
```
All six greps should match.
  </verify>
  <done>Both MQTT service files have network-online.target dependency and StartLimitIntervalSec=300 / StartLimitBurst=10 restart limits.</done>
</task>

<task type="auto">
  <name>Task 2: Harden remaining idle detection service units</name>
  <files>
linuxmini/systemd/user/in-office-monitor.service
linuxmini/systemd/user/mqtt_linux-webcam-status.service
linuxmini/systemd/user/hypridle.service
  </files>
  <action>
Add restart limits to the remaining three services. These don't need network-online.target (they're local services), but they need protection against restart loops.

**For in-office-monitor.service:**
Add to `[Service]` section:
```ini
StartLimitIntervalSec=300
StartLimitBurst=10
```
Keep existing `Restart=on-failure` and `RestartSec=5`.

**For mqtt_linux-webcam-status.service:**
This service currently has `Restart=always` but no `RestartSec`, which means it restarts immediately on any exit (including clean exit). Fix:
```ini
Restart=on-failure
RestartSec=5
StartLimitIntervalSec=300
StartLimitBurst=10
```
Change `Restart=always` to `Restart=on-failure` since clean exits should not trigger a restart. Add `RestartSec=5` to prevent rapid restart loops.

**For hypridle.service:**
Add to `[Service]` section:
```ini
StartLimitIntervalSec=300
StartLimitBurst=10
```
Keep existing `Restart=on-failure` and `RestartSec=1` (hypridle should restart quickly since it's the primary idle detector).
  </action>
  <verify>
```bash
grep 'StartLimitIntervalSec=300' linuxmini/systemd/user/in-office-monitor.service
grep 'StartLimitBurst=10' linuxmini/systemd/user/in-office-monitor.service
grep 'Restart=on-failure' linuxmini/systemd/user/mqtt_linux-webcam-status.service
grep 'RestartSec=5' linuxmini/systemd/user/mqtt_linux-webcam-status.service
grep 'StartLimitIntervalSec=300' linuxmini/systemd/user/mqtt_linux-webcam-status.service
grep 'StartLimitIntervalSec=300' linuxmini/systemd/user/hypridle.service
```
All greps should match.
  </verify>
  <done>All five idle detection service units have StartLimitIntervalSec and StartLimitBurst configured. Webcam service changed from Restart=always to Restart=on-failure with RestartSec.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Deploy and verify all services are running</name>
  <action>
Updated all five systemd service units with restart limits and network dependencies. The MQTT services now wait for network-online.target. All services have StartLimitIntervalSec=300 and StartLimitBurst=10 to survive transient failures without permanently stopping.

Verification steps:
1. Deploy changes: `cd ~/.dotfiles && python setup.py`
2. Reload systemd: `systemctl --user daemon-reload`
3. Restart the crashed mqtt_listener: `systemctl --user restart mqtt_listener.service`
4. Restart mqtt_reports: `systemctl --user restart mqtt_reports.service`
5. Check both are running: `systemctl --user status mqtt_listener.service mqtt_reports.service`
6. Verify in_office_status updates: `cat /tmp/mqtt/in_office_status` (should show "on" or "off" after a few seconds)
7. Check mqtt_reports publishes: `journalctl --user -u mqtt_reports.service --since '1 min ago' --no-pager | tail -20`
  </action>
  <verify>User confirms services are running and communicating.</verify>
  <done>All idle detection services start, stay running, and communicate with Home Assistant via MQTT.</done>
</task>

</tasks>

<verification>
1. All five service files contain `StartLimitIntervalSec=300` and `StartLimitBurst=10`
2. Both MQTT services reference `network-online.target` in Wants and After
3. Webcam service uses `Restart=on-failure` instead of `Restart=always`
4. No existing directives (PartOf, PassEnvironment, etc.) were accidentally removed
5. After deployment: `systemctl --user status mqtt_listener mqtt_reports` shows both active
</verification>

<success_criteria>
All idle detection systemd services have consistent restart policies preventing permanent failure after transient issues. MQTT services wait for network availability before starting. After `setup.py` deployment and `daemon-reload`, all services start and run successfully.
</success_criteria>

<output>
After completion, create `.planning/phases/01-idle-detection-reliability/01-02-SUMMARY.md`
</output>
