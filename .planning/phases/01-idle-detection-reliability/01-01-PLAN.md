---
phase: 01-idle-detection-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - linuxmini/scripts/mqtt/mqtt_listener.py
  - linuxmini/scripts/mqtt/mqtt_reports.py
autonomous: true

must_haves:
  truths:
    - "mqtt_listener.service starts and stays running without crashing on paho-mqtt 1.6.x"
    - "mqtt_reports.service publishes status changes without 'client is not currently connected' warnings during normal operation"
    - "Both MQTT services automatically reconnect when broker goes offline and comes back"
    - "on_disconnect handler does not crash regardless of paho-mqtt version installed"
  artifacts:
    - path: "linuxmini/scripts/mqtt/mqtt_listener.py"
      provides: "MQTT listener with paho-mqtt 1.6.x compatible callbacks and built-in reconnection"
      contains: "def on_disconnect"
    - path: "linuxmini/scripts/mqtt/mqtt_reports.py"
      provides: "MQTT reporter with paho-mqtt 1.6.x compatible callbacks and built-in reconnection"
      contains: "def on_disconnect"
  key_links:
    - from: "linuxmini/scripts/mqtt/mqtt_listener.py"
      to: "paho.mqtt.client"
      via: "on_disconnect callback signature"
      pattern: "def on_disconnect\\(client, userdata, rc\\)"
    - from: "linuxmini/scripts/mqtt/mqtt_reports.py"
      to: "paho.mqtt.client"
      via: "on_disconnect callback signature"
      pattern: "def on_disconnect\\(client, userdata, rc\\)"
---

<objective>
Fix the critical paho-mqtt API incompatibility that crashes mqtt_listener.service and fix the broken reconnection logic in both MQTT scripts.

Purpose: mqtt_listener.service is dead due to `mqtt.DisconnectFlags` AttributeError (paho-mqtt 2.0 API used on 1.6.x). mqtt_reports.service has the same bug plus flawed custom reconnection logic that fights with paho-mqtt's built-in reconnection. Both services are core to the idle detection feedback loop with Home Assistant.

Output: Two fixed Python scripts that work with paho-mqtt 1.6.x, use paho-mqtt's built-in reconnection instead of custom `safe_reconnect()`, and handle disconnections gracefully.
</objective>

<execution_context>
@/home/rash/.claude/get-shit-done/workflows/execute-plan.md
@/home/rash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-idle-detection-reliability/01-RESEARCH.md
@linuxmini/scripts/mqtt/mqtt_listener.py
@linuxmini/scripts/mqtt/mqtt_reports.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix paho-mqtt compatibility and reconnection in mqtt_listener.py</name>
  <files>linuxmini/scripts/mqtt/mqtt_listener.py</files>
  <action>
Fix two bugs in mqtt_listener.py:

**Bug 1 - DisconnectFlags crash (line 140):**
Replace the `on_disconnect` handler. Remove the `isinstance(rc, mqtt.DisconnectFlags)` check entirely. In paho-mqtt 1.6.x, `rc` is an integer (0 = clean disconnect, non-zero = unexpected). Replace with:
```python
def on_disconnect(client, userdata, rc):
    global broker_online
    broker_online = False
    if rc == 0:
        logging.info("Disconnected cleanly")
    else:
        logging.warning(f"Unexpected disconnect (rc={rc}), paho-mqtt will auto-reconnect")
```
Do NOT publish offline status in on_disconnect - the will message handles this automatically. Do NOT call `safe_reconnect()` - `loop_forever()` handles reconnection automatically via `reconnect_delay_set()`.

**Bug 2 - Remove custom reconnection logic:**
Delete the entire `safe_reconnect()` function (lines 74-93). Delete the `reconnecting` global variable and the `RECONNECT_DELAY` constant. The `loop_forever()` call in `main()` combined with `client.reconnect_delay_set(min_delay=1, max_delay=300)` already handles automatic reconnection with exponential backoff. Custom reconnection fights with this built-in behavior.

Also remove `reconnecting` from the `on_connect` function where it sets `reconnecting = False`.

Keep everything else unchanged: `on_connect`, `on_connect_fail`, `on_message`, `subscribe_to_topics`, `write_status_file`, `main()` structure.
  </action>
  <verify>
Run `python3 -c "import ast; ast.parse(open('/home/rash/.dotfiles/linuxmini/scripts/mqtt/mqtt_listener.py').read()); print('Syntax OK')"` to verify no syntax errors.

Verify `DisconnectFlags` is gone: `grep -c 'DisconnectFlags' linuxmini/scripts/mqtt/mqtt_listener.py` should return 0.

Verify `safe_reconnect` is gone: `grep -c 'safe_reconnect' linuxmini/scripts/mqtt/mqtt_listener.py` should return 0.

Verify on_disconnect exists and handles integer rc: `grep -A5 'def on_disconnect' linuxmini/scripts/mqtt/mqtt_listener.py` should show the new handler.
  </verify>
  <done>mqtt_listener.py has no reference to DisconnectFlags, no safe_reconnect function, on_disconnect treats rc as integer, and loop_forever handles reconnection.</done>
</task>

<task type="auto">
  <name>Task 2: Fix paho-mqtt compatibility and reconnection in mqtt_reports.py</name>
  <files>linuxmini/scripts/mqtt/mqtt_reports.py</files>
  <action>
Fix the same two bugs in mqtt_reports.py:

**Bug 1 - DisconnectFlags crash (line 187):**
Replace the `on_disconnect` handler identically to mqtt_listener.py. Remove the `isinstance(rc, mqtt.DisconnectFlags)` check. In paho-mqtt 1.6.x, `rc` is an integer. Replace with:
```python
def on_disconnect(client, userdata, rc):
    global broker_online
    broker_online = False
    if rc == 0:
        logging.info("Disconnected cleanly")
    else:
        logging.warning(f"Unexpected disconnect (rc={rc}), paho-mqtt will auto-reconnect")
```
Do NOT publish offline status in on_disconnect - the will message handles this. Do NOT call `safe_reconnect()` - `loop_start()` handles reconnection automatically.

**Bug 2 - Remove custom reconnection logic:**
Delete the entire `safe_reconnect()` function (lines 122-143). Delete the `reconnecting` global variable, `reconnect_lock`, and `RECONNECT_DELAY` constant. Remove the `import threading` if it's only used for `reconnect_lock` (check: `threading.Thread` is also used for the watchdog, so keep `import threading`). The `loop_start()` call combined with `client.reconnect_delay_set(min_delay=1, max_delay=300)` handles automatic reconnection.

Also remove `reconnecting` from `on_connect` where it sets `reconnecting = False`. Remove the `reconnecting` check from `on_message` (the broker offline handler around line 217 that calls `safe_reconnect`). That block should just set `broker_online = False` without attempting reconnection - paho handles it.

Keep everything else unchanged: file watching, `publish_file_contents`, `ensure_files_exist`, `main()` structure with `loop_start()`.
  </action>
  <verify>
Run `python3 -c "import ast; ast.parse(open('/home/rash/.dotfiles/linuxmini/scripts/mqtt/mqtt_reports.py').read()); print('Syntax OK')"` to verify no syntax errors.

Verify `DisconnectFlags` is gone: `grep -c 'DisconnectFlags' linuxmini/scripts/mqtt/mqtt_reports.py` should return 0.

Verify `safe_reconnect` is gone: `grep -c 'safe_reconnect' linuxmini/scripts/mqtt/mqtt_reports.py` should return 0.

Verify `reconnect_lock` is gone: `grep -c 'reconnect_lock' linuxmini/scripts/mqtt/mqtt_reports.py` should return 0.

Verify on_disconnect exists and handles integer rc: `grep -A5 'def on_disconnect' linuxmini/scripts/mqtt/mqtt_reports.py` should show the new handler.
  </verify>
  <done>mqtt_reports.py has no reference to DisconnectFlags, no safe_reconnect function, no reconnect_lock, on_disconnect treats rc as integer, and loop_start handles reconnection.</done>
</task>

</tasks>

<verification>
1. Both Python files parse without syntax errors
2. No references to `DisconnectFlags` in either file
3. No `safe_reconnect` function in either file
4. Both `on_disconnect` handlers treat `rc` as integer
5. `reconnect_delay_set` still present in both files (paho's built-in backoff)
6. `loop_forever()` still used in mqtt_listener.py, `loop_start()` still used in mqtt_reports.py
</verification>

<success_criteria>
Both MQTT scripts are syntactically valid Python, free of paho-mqtt 2.0 API references, and rely solely on paho-mqtt's built-in reconnection mechanism instead of custom reconnection logic.
</success_criteria>

<output>
After completion, create `.planning/phases/01-idle-detection-reliability/01-01-SUMMARY.md`
</output>
