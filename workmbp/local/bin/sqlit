#!/usr/bin/env bash
# SOPS-encrypted sqlit wrapper
# Decrypts connections.json before running sqlit, re-encrypts on exit

set -euo pipefail

SQLIT_DIR="$HOME/.sqlit"
CONNECTIONS_FILE="$SQLIT_DIR/connections.json"
SQLIT_BIN="$HOME/.local/share/uv/tools/sqlit-tui/bin/sqlit"

# Verify real sqlit exists
if [[ ! -x "$SQLIT_BIN" ]]; then
    echo "Error: Cannot find real sqlit at $SQLIT_BIN" >&2
    exit 1
fi

# Check if connections file exists
if [[ ! -f "$CONNECTIONS_FILE" ]]; then
    echo "No connections.json found. Running sqlit normally..." >&2
    exec "$SQLIT_BIN" "$@"
fi

# Check if file is SOPS-encrypted (JSON format has ENC[...] markers)
if ! grep -q "ENC\[AES256_GCM," "$CONNECTIONS_FILE" 2>/dev/null; then
    echo "ðŸ”’ Encrypting connections.json with SOPS..." >&2
    TEMP_FILE="$CONNECTIONS_FILE.encrypt.$$"
    sops --config /dev/null --encrypt --age age14x963l7j53w6psuuvsefsj5js5xwd6wue5csgg6mjzd568vwtgasjynzq7 "$CONNECTIONS_FILE" > "$TEMP_FILE"
    cat "$TEMP_FILE" > "$CONNECTIONS_FILE"
    rm -f "$TEMP_FILE"
    echo "âœ“ Encrypted successfully" >&2
fi

# Decrypt connections.json in place (preserves symlinks)
echo "ðŸ”“ Decrypting connections.json..." >&2
TEMP_FILE="$CONNECTIONS_FILE.$$"
sops -d "$CONNECTIONS_FILE" > "$TEMP_FILE"

# Set up trap to re-encrypt on exit (even if killed)
cleanup() {
    local exit_code=$?
    echo "ðŸ”’ Re-encrypting connections.json..." >&2
    # Re-encrypt in place (preserves symlinks)
    sops --config /dev/null --encrypt --age age14x963l7j53w6psuuvsefsj5js5xwd6wue5csgg6mjzd568vwtgasjynzq7 "$CONNECTIONS_FILE" > "$TEMP_FILE"
    cat "$TEMP_FILE" > "$CONNECTIONS_FILE"
    rm -f "$TEMP_FILE"
    exit $exit_code
}
trap cleanup EXIT INT TERM

# Replace encrypted content with decrypted content (preserves symlink)
cat "$TEMP_FILE" > "$CONNECTIONS_FILE"
rm -f "$TEMP_FILE"

# Run sqlit
"$SQLIT_BIN" "$@"
